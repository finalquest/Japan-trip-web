<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japan Trip Planner</title>
    <link rel="stylesheet" href="style.css">
    <!-- Leaflet CSS (OpenStreetMap) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- ZXing for barcode scanning -->
    <script src="/zxing-browser.min.js"></script>
    <script src="/barcode-scanner.js"></script>
    <script src="config.js"></script>
    <script>
        // Cargar Google Maps si hay API key configurada
        window.USE_GOOGLE_MAPS = false;
        if (typeof CONFIG !== 'undefined' && CONFIG.GOOGLE_MAPS_API_KEY) {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&libraries=places`;
            script.async = true;
            script.defer = true;
            script.onload = function() {
                window.USE_GOOGLE_MAPS = true;
            };
            document.head.appendChild(script);
        }
    </script>
</head>
<body>
    <nav class="navbar">
        <h1>üáØüáµ Japan Trip Planner</h1>
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('map')">üó∫Ô∏è Itinerario (KML)</button>
            <button class="tab-btn" onclick="showTab('findings')">üì∏ Encontr√© Esto</button>
            <button class="tab-btn" onclick="showUsersModal()" id="users-btn" style="display: none;">‚öôÔ∏è Usuarios</button>
        </div>
        <div class="user-info" id="user-info" style="display: none;">
            <span id="current-user"></span>
        </div>
    </nav>

    <main>
        <!-- Secci√≥n Mapa KML -->
        <section id="map-section" class="tab-content active">
            <!-- Modo Selecci√≥n -->
            <div id="kml-selector-mode" class="upload-area">
                <h2>Cargar itinerario (KML)</h2>
                
                <div class="kml-selector">
                    <label>üìÇ Seleccionar del repositorio:</label>
                    <select id="repo-kml-select">
                        <option value="">-- Elegir un KML guardado --</option>
                    </select>
                    <button type="button" onclick="loadRepoKML()" class="btn-secondary">Cargar</button>
                </div>
                
                <div class="divider">o</div>
                
                <div class="manual-upload">
                    <label>üìÅ Subir archivo manual:</label>
                    <input type="file" id="kml-input" accept=".kml,.kmz" />
                </div>
                
                <p class="hint">Los KMLs se sincronizan desde: github.com/finalquest/tokyo2026</p>
            </div>
            
            <!-- Modo Visualizaci√≥n (oculto inicialmente) -->
            <div id="kml-viewer-mode" class="viewer-mode" style="display: none;">
                <button onclick="backToSelector()" class="btn-back">‚Üê Volver a cargar KML</button>
            </div>
            
            <div id="map-container" class="map-default"></div>
            <div id="route-info"></div>
        </section>

        <!-- Secci√≥n Encontr√© Esto -->
        <section id="findings-section" class="tab-content">
            <div class="add-finding">
                <h2>üì∏ Encontr√© algo interesante</h2>
                
                <!-- Paso 1: Elegir entre foto o barcode -->
                <div id="camera-step" class="camera-only">
                    <div class="capture-options">
                        <button type="button" class="btn-camera-large" onclick="document.getElementById('finding-photo').click()">
                            üì∏
                        </button>
                        <span class="option-label">Foto</span>
                    </div>
                    
                    <div class="capture-options">
                        <button type="button" class="btn-barcode-large" onclick="startBarcodeScan()">
                            üìä
                        </button>
                        <span class="option-label">C√≥digo de barras</span>
                    </div>
                    
                    <input type="file" id="finding-photo" accept="image/*" capture="environment" required style="display: none;">
                    <p class="camera-hint">Eleg√≠ c√≥mo capturar el producto</p>
                </div>
                
                <!-- Paso 1b: Escanear barcode -->
                <div id="barcode-step" class="barcode-scanner" style="display: none;">
                    <div id="barcode-video-container">
                        <video id="barcode-video" playsinline></video>
                        <div class="scan-line"></div>
                    </div>
                    <button type="button" class="btn-cancel" onclick="cancelBarcodeScan()">‚ùå Cancelar</button>
                </div>
                
                <!-- Paso 2: Formulario completo (aparece despu√©s de sacar foto) -->
                <form id="finding-form" style="display: none;">
                    <div class="photo-preview-container">
                        <img id="photo-preview" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <button type="button" class="btn-retake" onclick="retakePhoto()">üîÑ Volver a sacar</button>
                    </div>
                    
                    <div class="form-group">
                        <label>¬øQu√© es?</label>
                        <input type="text" id="finding-title" placeholder="Ej: Figura de Gundam vintage" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Descripci√≥n / Notas:</label>
                        <textarea id="finding-desc" placeholder="Precio, tienda, por qu√© no lo compraste, etc."></textarea>
                    </div>

                    <div class="form-group ocr-section">
                        <label>üì∑ Imagen con texto japon√©s:</label>
                        <input type="file" id="ocr-image" accept="image/*" capture="environment">
                        <button type="button" onclick="extractText()" id="extract-btn">Extraer y traducir</button>
                        <div id="ocr-loading" class="loading-indicator" style="display: none;">‚è≥ Procesando imagen...</div>
                    </div>

                    <div class="form-group">
                        <label>Tienda / Ubicaci√≥n:</label>
                        <input type="text" id="finding-location" placeholder="Ej: Surugaya Akihabara">
                        <button type="button" onclick="getCurrentLocation()">üìç Usar mi ubicaci√≥n actual</button>
                        <input type="hidden" id="finding-lat">
                        <input type="hidden" id="finding-lng">
                    </div>
                    
                    <div class="form-group">
                        <label>Tags:</label>
                        <div class="tags-input">
                            <span class="tag" onclick="toggleTag(this)">#figure</span>
                            <span class="tag" onclick="toggleTag(this)">#retro</span>
                            <span class="tag" onclick="toggleTag(this)">#snacks</span>
                            <span class="tag" onclick="toggleTag(this)">#electronics</span>
                            <span class="tag" onclick="toggleTag(this)">#book</span>
                            <span class="tag" onclick="toggleTag(this)">#clothes</span>
                            <span class="tag" onclick="toggleTag(this)">#expensive</span>
                            <input type="hidden" id="finding-tags">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-primary">üíæ Guardar</button>
                </form>
            </div>
            
            <div class="findings-list">
                <h2>Mis descubrimientos (<span id="findings-count">0</span>)</h2>
                <div id="findings-grid"></div>
            </div>
        </section>
    </main>

    <!-- Login Modal -->
    <div id="login-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h2>üîê Iniciar Sesi√≥n</h2>
            <form id="login-form">
                <div class="form-group">
                    <label>Usuario:</label>
                    <input type="text" id="login-username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Contrase√±a:</label>
                    <input type="password" id="login-password" required autocomplete="current-password">
                </div>
                <div id="login-error" class="error-message" style="display: none; color: red; margin-bottom: 1rem;"></div>
                <button type="submit" class="btn-primary">Ingresar</button>
            </form>
        </div>
    </div>

    <!-- Users Management Modal -->
    <div id="users-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üë• Gesti√≥n de Usuarios</h2>
                <button onclick="closeUsersModal()" class="btn-close">‚úï</button>
            </div>
            
            <div class="users-list-container">
                <h3>Usuarios existentes:</h3>
                <div id="users-list"></div>
            </div>
            
            <div class="add-user-form">
                <h3>Agregar nuevo usuario:</h3>
                <form id="add-user-form">
                    <div class="form-group">
                        <input type="text" id="new-username" placeholder="Nombre de usuario" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="new-password" placeholder="Contrase√±a" required>
                    </div>
                    <button type="submit" class="btn-secondary">Agregar Usuario</button>
                </form>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script src="app.js"></script>
</body>
</html>
